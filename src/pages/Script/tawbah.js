document.addEventListener('DOMContentLoaded', function() {
    // عناصر DOM
    const sinsGrid = document.getElementById('sins-grid');
    const doubtsContainer = document.getElementById('doubts-container');
    const storiesGrid = document.getElementById('stories-grid');
    const pledgeBtn = document.getElementById('pledge-btn');
    const modalPledgeBtn = document.getElementById('modal-pledge-btn');
    const pledgeStats = document.getElementById('pledge-stats');
    const sinModal = document.getElementById('sin-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    const closeModal = document.getElementById('close-modal');
    const calendarContainer = document.getElementById('calendar');
    const calendarTitle = document.getElementById('calendar-title');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const currentMonthDaysEl = document.getElementById('current-month-days');
    const currentStreakEl = document.getElementById('current-streak');
    const totalDaysEl = document.getElementById('total-days');
    const storyForm = document.getElementById('story-form');
    const categoryBtns = document.querySelectorAll('.category-btn');
    
    // حالة التطبيق
    let currentSin = null;
    let pledgeDays = localStorage.getItem('pledgeDays') ? parseInt(localStorage.getItem('pledgeDays')) : 0;
    let lastPledgeDate = localStorage.getItem('lastPledgeDate');
    let pledgeHistory = JSON.parse(localStorage.getItem('pledgeHistory')) || [];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    
    // بيانات الذنوب الشائعة (تم توسيعها)
    const commonSins = [
        {
            name: "الغيبة والنميمة",
            description: "ذكر المسلم بما يكره في غيابه أو نقل الكلام للإفساد بين الناس",
            whySin: "الغيبة والنميمة من الكبائر التي تهتك أعراض المسلمين وتفرق بينهم، وقد شبهها النبي ﷺ بأكل لحم الأخ ميتاً.",
            severity: "من الكبائر التي توعد الله عليها بالنار",
            repentanceSteps: [
                "الندم على ما فات من الغيبة والنميمة",
                "الإقلاع الفوري عن هذه المعصية",
                "الاستغفار والتوبة إلى الله",
                "طلب المسامحة ممن اغتبتهم إذا أمكن دون إثارة فتنة",
                "ذكر محاسن من كنت تغتابه",
                "إصلاح ما أفسدته النميمة بين الناس إذا أمكن"
            ],
            reward: "من تاب من الغيبة والنميمة غفر الله له وأبدله حسنات، ويدخل في قوله تعالى: {إِلَّا مَن تَابَ وَآمَنَ وَعَمِلَ عَمَلًا صَالِحًا فَأُولَٰئِكَ يُبَدِّلُ اللَّهُ سَيِّئَاتِهِمْ حَسَنَاتٍ} [الفرقان:70]",
            evidences: [
                {
                    text: "قال تعالى: {وَلَا يَغْتَب بَّعْضُكُم بَعْضًا ۚ أَيُحِبُّ أَحَدُكُمْ أَن يَأْكُلَ لَحْمَ أَخِيهِ مَيْتًا فَكَرِهْتُمُوهُ} [الحجرات:12]",
                    ref: "سورة الحجرات، الآية 12"
                },
                {
                    text: "قال النبي ﷺ: \"الغيبة ذكرك أخاك بما يكره\" قيل: أفرأيت إن كان في أخي ما أقول؟ قال: \"إن كان فيه ما تقول فقد اغتبته، وإن لم يكن فيه ما تقول فقد بهته\"",
                    ref: "رواه مسلم"
                },
                {
                    text: "قال النبي ﷺ: \"لا يدخل الجنة نمام\"",
                    ref: "متفق عليه"
                }
            ],
            category: "major"
        },
        {
            name: "ترك الصلاة",
            description: "التهاون في أداء الصلوات المفروضة أو تأخيرها عن وقتها",
            whySin: "الصلاة هي عماد الدين والركن الثاني من أركان الإسلام، وتركها كفر عند كثير من العلماء.",
            severity: "من أعظم الذنوب عند الله تعالى",
            repentanceSteps: [
                "التوبة الصادقة والندم على ما فات",
                "المحافظة على الصلوات في أوقاتها",
                "تدارك ما فات من الصلوات بقضائها",
                "الاستعانة بالله والدعاء بالثبات",
                "صحبة الصالحين المحافظين على الصلاة",
                "تعلم أحكام الصلاة وأهميتها"
            ],
            reward: "من تاب وأقام الصلاة غفر الله له ورفع درجاته، كما في الحديث: \"الصلوات الخمس كفارة لما بينهن ما لم تغش الكبائر\"",
            evidences: [
                {
                    text: "قال تعالى: {فَخَلَفَ مِن بَعْدِهِمْ خَلْفٌ أَضَاعُوا الصَّلَاةَ وَاتَّبَعُوا الشَّهَوَاتِ ۖ فَسَوْفَ يَلْقَوْنَ غَيًّا} [مريم:59]",
                    ref: "سورة مريم، الآية 59"
                },
                {
                    text: "قال النبي ﷺ: \"العهد الذي بيننا وبينهم الصلاة، فمن تركها فقد كفر\"",
                    ref: "رواه الترمذي وصححه الألباني"
                },
                {
                    text: "قال النبي ﷺ: \"بين الرجل وبين الكفر والشرك ترك الصلاة\"",
                    ref: "رواه مسلم"
                }
            ],
            category: "major"
        },
        {
            name: "عقوق الوالدين",
            description: "إيذاء الوالدين أو التقصير في حقهما أو عدم برهما",
            whySin: "عقوق الوالدين من الكبائر التي توعد الله عليها بالعذاب، وقد قرن الله حقها بحقه سبحانه.",
            severity: "من أكبر الكبائر بعد الشرك بالله",
            repentanceSteps: [
                "الندم على ما صدر من عقوق",
                "طلب المسامحة من الوالدين",
                "الإحسان إليهما بالقول والفعل",
                "طاعتهما في غير معصية الله",
                "الدعاء لهما بالرحمة والمغفرة",
                "برهما بعد موتهما بالدعاء والصدقة"
            ],
            reward: "من تاب من العقوق وأحسن إلى والديه فتح الله له أبواب الرحمة، كما في الحديث: \"رغم أنفه، رغم أنفه، رغم أنفه، قيل: من يا رسول الله؟ قال: من أدرك والديه عند الكبر أحدهما أو كليهما ثم لم يدخل الجنة\"",
            evidences: [
                {
                    text: "قال تعالى: {وَقَضَىٰ رَبُّكَ أَلَّا تَعْبُدُوا إِلَّا إِيَّاهُ وَبِالْوَالِدَيْنِ إِحْسَانًا} [الإسراء:23]",
                    ref: "سورة الإسراء، الآية 23"
                },
                {
                    text: "قال النبي ﷺ: \"ألا أنبئكم بأكبر الكبائر؟ الإشراك بالله، وعقوق الوالدين\"",
                    ref: "متفق عليه"
                },
                {
                    text: "قال النبي ﷺ: \"رضا الرب في رضا الوالد، وسخط الرب في سخط الوالد\"",
                    ref: "رواه الترمذي وحسنه"
                }
            ],
            category: "major"
        },
        {
            name: "الربا",
            description: "أكل المال الحرام عن طريق القروض الربوية أو المعاملات المحرمة",
            whySin: "الربا من أكبر الكبائر التي حاربها الإسلام، وقد توعد الله آكله بالحرب منه سبحانه.",
            severity: "من الذنوب العظيمة التي تستوجب اللعنة",
            repentanceSteps: [
                "التوبة الصادقة والندم على ما مضى",
                "الإقلاع الفوري عن جميع معاملات الربا",
                "التخلص من الأموال الربوية بالتصدق بها",
                "الاستغفار بكثرة والإنابة إلى الله",
                "تعلم أحكام المعاملات الشرعية",
                "اللجوء إلى البدائل الشرعية للقروض"
            ],
            reward: "من تاب من الربا غفر الله له وأبدله خيراً منه، كما في الحديث: \"من تاب قبل موته بسنة تاب الله عليه\"",
            evidences: [
                {
                    text: "قال تعالى: {يَا أَيُّهَا الَّذِينَ آمَنُوا اتَّقُوا اللَّهَ وَذَرُوا مَا بَقِيَ مِنَ الرِّبَا إِن كُنتُم مُّؤْمِنِينَ * فَإِن لَّمْ تَفْعَلُوا فَأْذَنُوا بِحَرْبٍ مِّنَ اللَّهِ وَرَسُولِهِ} [البقرة:278-279]",
                    ref: "سورة البقرة، الآيتان 278-279"
                },
                {
                    text: "قال النبي ﷺ: \"اجتنبوا السبع الموبقات\" وذكر منها: \"أكل الربا\"",
                    ref: "متفق عليه"
                },
                {
                    text: "قال النبي ﷺ: \"درهم ربا يأكله الرجل وهو يعلم أشد من ستة وثلاثين زنية\"",
                    ref: "رواه أحمد وصححه الألباني"
                }
            ],
            category: "major"
        },
        {
            name: "الكذب",
            description: "قول ما يخالف الحقيقة سواء في المزاح أو الجد",
            whySin: "الكذب من صفات المنافقين، وهو طريق إلى النار، ويجر إلى كثير من الذنوب الأخرى.",
            severity: "من الصفات الذميمة التي نهى عنها الإسلام",
            repentanceSteps: [
                "الاعتراف بالذنب والندم عليه",
                "العزم على الصدق في جميع الأحوال",
                "تذكر عواقب الكذب وعذاب الآخرة",
                "التدرب على قول الحق ولو كان مراً",
                "الاستعانة بالله في التخلص من هذه العادة",
                "تصحيح ما يمكن تصحيحه من الأكاذيب السابقة"
            ],
            reward: "من تاب من الكذب وصدق في حديثه كتب عند الله صديقاً، كما في الحديث: \"عليكم بالصدق فإن الصدق يهدي إلى البر\"",
            evidences: [
                {
                    text: "قال تعالى: {إِنَّمَا يَفْتَرِي الْكَذِبَ الَّذِينَ لَا يُؤْمِنُونَ بِآيَاتِ اللَّهِ ۖ وَأُولَٰئِكَ هُمُ الْكَاذِبُونَ} [النحل:105]",
                    ref: "سورة النحل، الآية 105"
                },
                {
                    text: "قال النبي ﷺ: \"إياكم والكذب، فإن الكذب يهدي إلى الفجور، وإن الفجور يهدي إلى النار\"",
                    ref: "متفق عليه"
                },
                {
                    text: "قال النبي ﷺ: \"ويل للذي يحدث فيكذب ليضحك به القوم، ويل له، ويل له\"",
                    ref: "رواه أبو داود والترمذي"
                }
            ],
            category: "major"
        },
        {
            name: "الغش",
            description: "خداع الناس في المعاملات أو إخفاء العيوب أو التلاعب في الموازين",
            whySin: "الغش صفة ذميمة تخالف الأمانة التي أمر الله بها، وتؤدي إلى انتشار الظلم في المجتمع.",
            severity: "من الذنوب التي تسبب اللعنة والخسران",
            repentanceSteps: [
                "التوبة النصوح والندم على الغش",
                "رد الحقوق إلى أصحابها إذا أمكن",
                "الإخلاص في العمل وإتقانه",
                "التحلي بالأمانة في جميع المعاملات",
                "تذكر أن الله يراقب في السر والعلن",
                "التعويض عن الغش السابق بالإحسان"
            ],
            reward: "من تاب من الغش وأحسن في معاملاته كتب عند الله من الصادقين، كما في الحديث: \"التاجر الصدوق الأمين مع النبيين والصديقين والشهداء\"",
            evidences: [
                {
                    text: "قال تعالى: {وَيْلٌ لِّلْمُطَفِّفِينَ * الَّذِينَ إِذَا اكْتَالُوا عَلَى النَّاسِ يَسْتَوْفُونَ * وَإِذَا كَالُوهُمْ أَو وَّزَنُوهُمْ يُخْسِرُونَ} [المطففين:1-3]",
                    ref: "سورة المطففين، الآيات 1-3"
                },
                {
                    text: "قال النبي ﷺ: \"من غشنا فليس منا\"",
                    ref: "رواه مسلم"
                },
                {
                    text: "قال النبي ﷺ: \"البيعان بالخيار ما لم يتفرقا، فإن صدقا وبينا بورك لهما في بيعهما، وإن كتما وكذبا محقت بركة بيعهما\"",
                    ref: "متفق عليه"
                }
            ],
            category: "major"
        },
        {
            name: "الرياء",
            description: "فعل العبادة أو العمل الصالح ليراه الناس ويحمدوه لا لوجه الله",
            whySin: "الرياء يبطل العمل ويحبط الأجر، وهو من الشرك الخفي الذي حذر منه النبي ﷺ.",
            severity: "من الذنوب الخطيرة التي تهدم الأعمال الصالحة",
            repentanceSteps: [
                "الإخلاص لله في جميع الأعمال",
                "إخفاء العبادات ما أمكن",
                "تذكر عذاب الرياء في الآخرة",
                "الدعاء بالحماية من الرياء",
                "مراقبة النية وتجديدها باستمرار",
                "تصحيح النية للعمل إذا دخلها الرياء"
            ],
            reward: "من تاب من الرياء وأخلص لله أعطاه الله الأجر العظيم، كما في الحديث: \"إنما الأعمال بالنيات\"",
            evidences: [
                {
                    text: "قال تعالى: {فَمَن كَانَ يَرْجُو لِقَاءَ رَبِّهِ فَلْيَعْمَلْ عَمَلًا صَالِحًا وَلَا يُشْرِكْ بِعِبَادَةِ رَبِّهِ أَحَدًا} [الكهف:110]",
                    ref: "سورة الكهف، الآية 110"
                },
                {
                    text: "قال النبي ﷺ: \"أخوف ما أخاف عليكم الشرك الأصغر: الرياء\"",
                    ref: "رواه أحمد وصححه الألباني"
                },
                {
                    text: "قال النبي ﷺ: \"من سمّع سمّع الله به، ومن يرائي يرائي الله به\"",
                    ref: "متفق عليه"
                }
            ],
            category: "heart"
        },
        {
            name: "هدر الوقت",
            description: "إضاعة الوقت في ما لا ينفع أو يضر في الدنيا والآخرة",
            whySin: "الوقت هو رأس مال المسلم الذي سيُسأل عنه يوم القيامة، وإضاعته من الغبن العظيم.",
            severity: "من الذنوب التي تسبب الندم يوم القيامة",
            repentanceSteps: [
                "تنظيم الوقت واستثماره في الطاعات",
                "تجنب الملهيات واللغو",
                "تذكر سؤال الله عن العمر فيما أفناه",
                "وضع برنامج يومي مفيد",
                "صحبة من يعين على استغلال الوقت",
                "البدء بالأعمال الصالحة فوراً"
            ],
            reward: "من تاب من إضاعة الوقت واستغله في الخير كتب له الأجر المضاعف، كما في الحديث: \"نعمتان مغبون فيهما كثير من الناس: الصحة والفراغ\"",
            evidences: [
                {
                    text: "قال تعالى: {وَٱلْعَصْرِ * إِنَّ ٱلْإِنسَٰنَ لَفِى خُسْرٍ * إِلَّا ٱلَّذِينَ ءَامَنُوا۟ وَعَمِلُوا۟ ٱلصَّٰلِحَٰتِ وَتَوَاصَوْا۟ بِٱلْحَقِّ وَتَوَاصَوْا۟ بِٱلصَّبْرِ} [العصر:1-3]",
                    ref: "سورة العصر، الآيات 1-3"
                },
                {
                    text: "قال النبي ﷺ: \"لا تزول قدما عبد يوم القيامة حتى يسأل عن أربع: عن عمره فيما أفناه، وعن شبابه فيما أبلاه، وعن ماله من أين اكتسبه وفيما أنفقه، وعن علمه ماذا عمل به\"",
                    ref: "رواه الترمذي وحسنه"
                },
                {
                    text: "قال النبي ﷺ: \"اغتنم خمساً قبل خمس: حياتك قبل موتك، وصحتك قبل سقمك، وفراغك قبل شغلك، وشبابك قبل هرمك، وغناك قبل فقرك\"",
                    ref: "رواه الحاكم وصححه"
                }
            ],
            category: "minor"
        },
        {
            name: "عدم غض البصر",
            description: "النظر إلى ما حرم الله من النساء الأجنبيات أو الصور المحرمة",
            whySin: "النظر المحرم يوقع في الفتنة ويجر إلى الفحش، وهو من أسباب الزنا القلبي.",
            severity: "من الذنوب التي تسبب قسوة القلب وتضعف الإيمان",
            repentanceSteps: [
                "غض البصر فوراً عن المحرمات",
                "تذكر مراقبة الله في كل حال",
                "تجنب الأماكن التي تكثر فيها الفتن",
                "الصوم لتقوية الإرادة",
                "الدعاء بالعفة والستر",
                "تزويج من لا يستطيع الصبر"
            ],
            reward: "من غض بصره عن الحرام أبدله الله نوراً في القلب وفراسة في الدين، كما في الحديث: \"النظرة سهم من سهام إبليس\"",
            evidences: [
                {
                    text: "قال تعالى: {قُل لِّلْمُؤْمِنِينَ يَغُضُّوا مِنْ أَبْصَارِهِمْ وَيَحْفَظُوا فُرُوجَهُمْ ۚ ذَٰلِكَ أَزْكَىٰ لَهُمْ ۗ إِنَّ اللَّهَ خَبِيرٌ بِمَا يَصْنَعُونَ} [النور:30]",
                    ref: "سورة النور، الآية 30"
                },
                {
                    text: "قال النبي ﷺ: \"إن لك من الأجر مثل ما غضضت من بصرك\"",
                    ref: "رواه الطبراني وصححه الألباني"
                },
                {
                    text: "قال النبي ﷺ: \"العينان زناهما النظر\"",
                    ref: "متفق عليه"
                }
            ],
            category: "major"
        },
        {
            name: "سماع الأغاني",
            description: "سماع الألحان المحرمة وآلات اللهو التي تلهي عن ذكر الله",
            whySin: "الأغاني المحرمة تلهي عن ذكر الله وتورث قسوة القلب وتجر إلى المعاصي الأخرى.",
            severity: "من الذنوب التي تسبب قسوة القلب وتضعف الإيمان",
            repentanceSteps: [
                "التخلص من الأغاني المحرمة فوراً",
                "استبدالها بالأناشيد الإسلامية والقرآن",
                "تذكر عذاب الله للمستمعين",
                "مصاحبة الصالحين الذين يعينون على الخير",
                "شغل الوقت بالطاعات والنافع",
                "الدعاء بالثبات على الهداية"
            ],
            reward: "من تاب من سماع الأغاني وأبدلها بذكر الله فتح الله له أبواب الخير، كما في الحديث: \"ليكونن من أمتي أقوام يستحلون الحر والحرير والخمر والمعازف\"",
            evidences: [
                {
                    text: "قال تعالى: {وَمِنَ النَّاسِ مَن يَشْتَرِي لَهْوَ الْحَدِيثِ لِيُضِلَّ عَن سَبِيلِ اللَّهِ بِغَيْرِ عِلْمٍ وَيَتَّخِذَهَا هُزُوًا ۚ أُولَٰئِكَ لَهُمْ عَذَابٌ مُّهِينٌ} [لقمان:6]",
                    ref: "سورة لقمان، الآية 6"
                },
                {
                    text: "قال النبي ﷺ: \"ليكونن من أمتي أقوام يستحلون الحر والحرير والخمر والمعازف\"",
                    ref: "رواه البخاري"
                },
                {
                    text: "قال ابن مسعود: \"الغناء ينبت النفاق في القلب كما ينبت الماء الزرع\"",
                    ref: "إغاثة اللهفان لابن القيم"
                }
            ],
            category: "major"
        },
        {
            name: "العلاقات المحرمة",
            description: "العلاقات غير الشرعية بين الرجل والمرأة خارج إطار الزواج",
            whySin: "العلاقات المحرمة تسبب الفتنة وتجر إلى الفاحشة، وهي من أسباب غضب الله وعقابه.",
            severity: "من الكبائر التي توعد الله عليها بالعذاب",
            repentanceSteps: [
                "قطع العلاقات المحرمة فوراً",
                "التوبة الصادقة والندم على ما فات",
                "تذكر عذاب الله للزناة",
                "الزواج لمن يستطيع",
                "الصوم والعبادة لتقوية الإيمان",
                "تجنب أماكن الفتن والخلوة بالنساء"
            ],
            reward: "من تاب من العلاقات المحرمة غفر الله له وأبدله حلالاً طيباً، كما في الحديث: \"التائب من الذنب كمن لا ذنب له\"",
            evidences: [
                {
                    text: "قال تعالى: {وَلَا تَقْرَبُوا الزِّنَا ۖ إِنَّهُ كَانَ فَاحِشَةً وَسَاءَ سَبِيلًا} [الإسراء:32]",
                    ref: "سورة الإسراء، الآية 32"
                },
                {
                    text: "قال النبي ﷺ: \"ما تركت بعدي فتنة أضر على الرجال من النساء\"",
                    ref: "متفق عليه"
                },
                {
                    text: "قال النبي ﷺ: \"لا يخلون رجل بامرأة إلا وكان الشيطان ثالثهما\"",
                    ref: "رواه الترمذي وحسنه"
                }
            ],
            category: "major"
        },
        {
            name: "السرقة",
            description: "أخذ مال الغير بغير حق سواء كان سراً أو عنوة",
            whySin: "السرقة ظلم للمسلمين وتعدٍ على حقوقهم، وهي من الكبائر التي حرمها الله.",
            severity: "من الكبائر التي توعد الله عليها بالعذاب",
            repentanceSteps: [
                "رد المسروقات إلى أصحابها أو التعويض عنها",
                "التوبة الصادقة والندم على ما فات",
                "كثرة الاستغفار والإنابة إلى الله",
                "تعلم أحكام المال في الإسلام",
                "الكسب الحلال والعمل الشريف",
                "الصدقة والإحسان إلى الناس"
            ],
            reward: "من تاب من السرقة وأحسن غفر الله له وأبدله خيراً منها، كما في الحديث: \"التائب من الذنب كمن لا ذنب له\"",
            evidences: [
                {
                    text: "قال تعالى: {وَالسَّارِقُ وَالسَّارِقَةُ فَاقْطَعُوا أَيْدِيَهُمَا جَزَاءً بِمَا كَسَبَا نَكَالًا مِّنَ اللَّهِ ۗ وَاللَّهُ عَزِيزٌ حَكِيمٌ} [المائدة:38]",
                    ref: "سورة المائدة، الآية 38"
                },
                {
                    text: "قال النبي ﷺ: \"لا يزني الزاني حين يزني وهو مؤمن، ولا يسرق السارق حين يسرق وهو مؤمن\"",
                    ref: "متفق عليه"
                },
                {
                    text: "قال النبي ﷺ: \"اليد العليا خير من اليد السفلى\"",
                    ref: "متفق عليه"
                }
            ],
            category: "major"
        },
        {
            name: "الحسد",
            description: "تمني زوال النعمة عن الآخرين أو كراهية ما أنعم الله به عليهم",
            whySin: "الحسد يحرق الحسنات ويسبب العداوة والبغضاء بين المسلمين، وهو من أمراض القلوب الخطيرة.",
            severity: "من الذنوب التي تهلك صاحبها وتحرق حسناته",
            repentanceSteps: [
                "الرضا بقضاء الله وقدره",
                "الدعاء للمحسود بالبركة",
                "تذكر نعم الله الكثيرة",
                "الإكثار من قول \"ما شاء الله لا قوة إلا بالله\"",
                "الاستعاذة من شر الحاسد",
                "التوكل على الله والثقة برزقه"
            ],
            reward: "من تاب من الحسد وأحل محله المحبة والرضا كتب الله له الأجر العظيم، كما في الحديث: \"لا تحاسدوا ولا تباغضوا ولا تدابروا وكونوا عباد الله إخواناً\"",
            evidences: [
                {
                    text: "قال تعالى: {أَمْ يَحْسُدُونَ النَّاسَ عَلَىٰ مَا آتَاهُمُ اللَّهُ مِن فَضْلِهِ} [النساء:54]",
                    ref: "سورة النساء، الآية 54"
                },
                {
                    text: "قال النبي ﷺ: \"إياكم والحسد فإن الحسد يأكل الحسنات كما تأكل النار الحطب\"",
                    ref: "رواه أبو داود وصححه الألباني"
                },
                {
                    text: "قال النبي ﷺ: \"دب إليكم داء الأمم من قبلكم: الحسد والبغضاء\"",
                    ref: "رواه الترمذي وحسنه"
                }
            ],
            category: "heart"
        },
        {
            name: "الظلم",
            description: "التعدي على حقوق الآخرين أو أخذ ما ليس بحق",
            whySin: "الظلم ظلمات يوم القيامة، وقد حرم الله الظلم على نفسه وجعله بين الناس محرماً.",
            severity: "من الكبائر التي تستوجب العقاب الشديد",
            repentanceSteps: [
                "رد المظالم إلى أهلها",
                "طلب المسامحة ممن ظلمتهم",
                "التوبة الصادقة والندم على الظلم",
                "العدل في جميع المعاملات",
                "تذكر عذاب الله للظالمين",
                "الإحسان إلى من كنت تظلمهم"
            ],
            reward: "من تاب من الظلم وأحسن غفر الله له وأبدله عدلاً، كما في الحديث: \"اتقوا الظلم فإن الظلم ظلمات يوم القيامة\"",
            evidences: [
                {
                    text: "قال تعالى: {وَلَا تَحْسَبَنَّ اللَّهَ غَافِلًا عَمَّا يَعْمَلُ الظَّالِمُونَ ۚ إِنَّمَا يُؤَخِّرُهُمْ لِيَوْمٍ تَشْخَصُ فِيهِ الْأَبْصَارُ} [إبراهيم:42]",
                    ref: "سورة إبراهيم، الآية 42"
                },
                {
                    text: "قال النبي ﷺ: \"اتقوا الظلم فإن الظلم ظلمات يوم القيامة\"",
                    ref: "متفق عليه"
                },
                {
                    text: "قال النبي ﷺ: \"إن الله ليملي للظالم حتى إذا أخذه لم يفلته\"",
                    ref: "متفق عليه"
                }
            ],
            category: "major"
        },
        {
            name: "الغضب",
            description: "عدم التحكم في النفس عند الغضب والانفعال الشديد",
            whySin: "الغضب من الشيطان ويؤدي إلى أفعال وأقوال ندم عليها صاحبها، وقد حذر منه النبي ﷺ.",
            severity: "من الذنوب التي تسبب الندم وتجر إلى معاص أخرى",
            repentanceSteps: [
                "الاستعاذة بالله من الشيطان عند الغضب",
                "تغيير الوضعية بالجلوس أو الاضطجاع",
                "الوضوء أو الاغتسال",
                "الصمت وعدم التكلم أثناء الغضب",
                "تذكر فضل كظم الغيظ",
                "التدرب على الصبر والحلم"
            ],
            reward: "من تحكم في غضبه وكظم غيظه كتب الله له الأجر العظيم، كما في الحديث: \"ليس الشديد بالصرعة إنما الشديد الذي يملك نفسه عند الغضب\"",
            evidences: [
                {
                    text: "قال تعالى: {وَٱلْكَٰظِمِينَ ٱلْغَيْظَ وَٱلْعَافِينَ عَنِ ٱلنَّاسِ ۗ وَٱللَّهُ يُحِبُّ ٱلْمُحْسِنِينَ} [آل عمران:134]",
                    ref: "سورة آل عمران، الآية 134"
                },
                {
                    text: "قال النبي ﷺ: \"لا تغضب\" فردد مراراً، قال: \"لا تغضب\"",
                    ref: "رواه البخاري"
                },
                {
                    text: "قال النبي ﷺ: \"إذا غضب أحدكم فليسكت\"",
                    ref: "رواه أحمد وصححه الألباني"
                }
            ],
            category: "heart"
        },
        {
            name: "التسويف في التوبة",
            description: "تأجيل التوبة والاستمرار في المعصية",
            whySin: "التسويف في التوبة من حيل الشيطان ليوقع الإنسان في الهلاك، ولا يدري الإنسان متى يأتيه أجله.",
            severity: "من أخطر الذنوب لأنه يجر إلى استمرار المعاصي",
            repentanceSteps: [
                "التوبة الفورية دون تأجيل",
                "تذكر الموت المفاجئ",
                "الاستعاذة من التسويف",
                "تذكر قصص من ماتوا فجأة",
                "العزم الصادق على التوبة",
                "البدء بالتوبة من التسويف نفسه"
            ],
            reward: "من تاب من التسويف وأسرع في التوبة كتب الله له الأجر العظيم، كما في الحديث: \"إن الله يقبل توبة العبد ما لم يغرغر\"",
            evidences: [
                {
                    text: "قال تعالى: {وَأَنِيبُوا إِلَىٰ رَبِّكُمْ وَأَسْلِمُوا لَهُ مِن قَبْلِ أَن يَأْتِيَكُمُ الْعَذَابُ ثُمَّ لَا تُنصَرُونَ} [الزمر:54]",
                    ref: "سورة الزمر، الآية 54"
                },
                {
                    text: "قال النبي ﷺ: \"بادر بالأعمال سبعاً، هل تنتظرون إلا فقراً منسياً، أو غنى مطغياً، أو مرضاً مفسداً، أو هرماً مفنداً، أو موتاً مجهزاً، أو الدجال فشر غائب ينتظر، أو الساعة فالساعة أدهى وأمر\"",
                    ref: "رواه الترمذي وحسنه"
                },
                {
                    text: "قال الحسن البصري: \"حاسبوا أنفسكم قبل أن تحاسبوا، وزنوها قبل أن توزنوا\"",
                    ref: "الحلية لأبي نعيم"
                }
            ],
            category: "heart"
        },
        {
            name: "إضاعة الصلاة",
            description: "تأخير الصلاة عن وقتها أو التهاون في أدائها",
            whySin: "الصلاة هي عماد الدين، وإضاعتها من علامات النفاق، وهي أول ما يحاسب عليه العبد يوم القيامة.",
            severity: "من الذنوب العظيمة التي توعد الله عليها بالويل",
            repentanceSteps: [
                "المحافظة على الصلوات في أوقاتها",
                "تذكر عذاب المضيعين للصلاة",
                "صحبة المحافظين على الصلاة",
                "استخدام المنبهات للتذكير",
                "الدعاء بالثبات على الصلاة",
                "تدارك ما فات من الصلوات"
            ],
            reward: "من تاب وأقام الصلاة كتب الله له الأجر العظيم، كما في الحديث: \"من حافظ عليها كانت له نوراً وبرهاناً ونجاة يوم القيامة\"",
            evidences: [
                {
                    text: "قال تعالى: {فَوَيْلٌ لِّلْمُصَلِّينَ * الَّذِينَ هُمْ عَن صَلَاتِهِمْ سَاهُونَ} [الماعون:4-5]",
                    ref: "سورة الماعون، الآيتان 4-5"
                },
                {
                    text: "قال النبي ﷺ: \"بين الرجل وبين الشرك والكفر ترك الصلاة\"",
                    ref: "رواه مسلم"
                },
                {
                    text: "قال النبي ﷺ: \"أول ما يحاسب به العبد يوم القيامة الصلاة، فإن صلحت صلح سائر عمله، وإن فسدت فسد سائر عمله\"",
                    ref: "رواه الطبراني"
                }
            ],
            category: "major"
        },
        {
            name: "الاستهزاء بالدين",
            description: "السخرية من شعائر الإسلام أو الاستهانة بها",
            whySin: "الاستهزاء بالدين من نواقض الإسلام، وقد حذر الله منه أشد التحذير.",
            severity: "من الكبائر التي قد تخرج من الملة",
            repentanceSteps: [
                "التوبة الصادقة والندم",
                "تعظيم شعائر الله",
                "طلب العلم الشرعي",
                "صحبة الصالحين",
                "التعويض بالذب عن الدين",
                "كثرة الاستغفار"
            ],
            reward: "من تاب من الاستهزاء بالدين وأحسن غفر الله له، كما في قوله تعالى: {وَآخَرُونَ اعْتَرَفُوا بِذُنُوبِهِمْ خَلَطُوا عَمَلًا صَالِحًا وَآخَرَ سَيِّئًا عَسَى اللَّهُ أَن يَتُوبَ عَلَيْهِمْ} [التوبة:102]",
            evidences: [
                {
                    text: "قال تعالى: {وَلَئِن سَأَلْتَهُمْ لَيَقُولُنَّ إِنَّمَا كُنَّا نَخُوضُ وَنَلْعَبُ ۚ قُلْ أَبِاللَّهِ وَآيَاتِهِ وَرَسُولِهِ كُنتُمْ تَسْتَهْزِئُونَ * لَا تَعْتَذِرُوا قَدْ كَفَرْتُم بَعْدَ إِيمَانِكُمْ} [التوبة:65-66]",
                    ref: "سورة التوبة، الآيتان 65-66"
                },
                {
                    text: "قال النبي ﷺ: \"إن العبد ليتكلم بالكلمة ما يتبين فيها يزل بها في النار أبعد مما بين المشرق والمغرب\"",
                    ref: "متفق عليه"
                },
                {
                    text: "قال ابن تيمية: \"الاستهزاء بالدين كفر بإجماع المسلمين\"",
                    ref: "الصارم المسلول"
                }
            ],
            category: "major"
        }
    ];
    
    const commonDoubts = [
        {
            question: "لماذا يحرم الله أشياء نحبها مثل الموسيقى والعلاقات؟",
            answer: "الله تعالى يعلم ما يصلح عباده وما يفسدهم، وما حرمه إلا لما فيه من ضرر على الفرد والمجتمع. الحكمة قد تخفى علينا ولكننا نطيع الله لأنه أعلم بما يصلحنا."
        },
        {
            question: "كيف أتوب وأنا أعود للذنب مرة أخرى؟",
            answer: "التوبة النصوح تكون بالندم والإقلاع والعزم على عدم العودة، وإن عاد الإنسان للذنب فعليه أن يعاود التوبة. الله غفور رحيم يقبل توبة التائبين."
        },
        {
            question: "هل الله يغفر الذنوب الكبيرة مثل الزنا والسرقة؟",
            answer: "نعم، الله يغفر جميع الذنوب للتائبين مهما عظمت، قال تعالى: {قُلْ يَا عِبَادِيَ الَّذِينَ أَسْرَفُوا عَلَىٰ أَنفُسِهِمْ لَا تَقْنَطُوا مِن رَّحْمَةِ اللَّهِ ۚ إِنَّ اللَّهَ يَغْفِرُ الذُّنُوبَ جَمِيعًا ۚ إِنَّهُ هُوَ الْغَفُورُ الرَّحِيمُ} [الزمر:53]"
        },
        {
            question: "أنا أصلي وأصوم ولكن لا أشعر بلذة العبادة، ما الحل؟",
            answer: "هذا قد يكون بسبب الذنوب أو الغفلة، والحل في الإكثار من الاستغفار، تدبر القرآن، مصاحبة الصالحين، والدعاء بصلاح القلب."
        },
        {
            question: "كيف أتوب من ذنوب لا أستطيع تركها مثل التدخين؟",
            answer: "ابدأ بالعزم الصادق، واستعن بالله، وضع خطة تدريجية، واستبدل العادة السيئة بأخرى حسنة، واستشر المختصين إذا لزم الأمر."
        },
        {
            question: "هل التوبة تحتاج إلى شهود أو إعلان؟",
            answer: "لا، التوبة بين العبد وربه، ولا تحتاج إلى إعلان أو شهود، إلا إذا كانت تتعلق بحقوق العباد فيجب رد الحقوق لأصحابها."
        },
        {
            question: "كيف أعرف أن الله قد قبل توبتي؟",
            answer: "علامات قبول التوبة: الندم على الذنب، الإقلاع عنه، عدم العودة إليه، الشعور بالخوف من الله مع الرجاء في رحمته، وحسن العمل بعد التوبة."
        },
        {
            question: "هل يمكن التوبة عند المعاينة (عند رؤية ملك الموت)؟",
            answer: "التوبة مقبولة ما لم يغرغر الإنسان (يصل الروح إلى الحلقوم)، ولكن لا ينبغي تأخير التوبة لأن الموت يأتي بغتة."
        },
        {
            question: "كيف أتوب من ذنوب لا أتذكرها؟",
            answer: "يكفي أن تتوب توبة عامة من جميع الذنوب، وتستغفر الله مما لا تذكره، قال النبي ﷺ: \"الاستغفار يمحو الذنوب وإن كانت مثل زبد البحر\""
        },
        {
            question: "هل يمكن التوبة من الغيبة والنميمة مع عدم قدرتي على إخبار من اغتبتهم؟",
            answer: "نعم، تتوب إلى الله وتستغفره، وتذكر من اغتبته بالخير، وتصلح ما أفسدته النميمة إذا أمكن دون إثارة فتنة."
        },
        {
            question: "أنا متورط في الربا، كيف أتوب منه؟",
            answer: "تتوقف فوراً عن التعامل بالربا، وتتخلص من الأموال الربوية بالتصدق بها دون نية الأجر، وتتعلم أحكام المعاملات الشرعية."
        },
        {
            question: "كيف أتوب من التعلق بغير الله مثل التعلق الشديد بشخص؟",
            answer: "بالتوجه إلى الله بالدعاء، وإشغال القلب بحب الله وذكره، وتذكر أن التعلق بغير الله سبب للشقاء، ومصاحبة الصالحين."
        },
        {
            question: "هل يمكن التوبة من السحر؟",
            answer: "نعم، بالتوبة الصادقة، وإتلاف أدوات السحر، ورد الحقوق إذا كان هناك ضرر للغير، والالتزام بالرقية الشرعية."
        },
        {
            question: "كيف أتوب من مشاهدة الأفلام المحرمة؟",
            answer: "بالحذف الفوري لهذه المواد، وملء الوقت بالطاعات، وتذكر عذاب الله، واستبدالها بأفلام ومسلسلات مفيدة، وغض البصر."
        },
        {
            question: "أشعر أن ذنوبي كثيرة ولن يغفرها الله، ما الحل؟",
            answer: "هذا من وساوس الشيطان، فالله غفور رحيم يقبل التوبة عن عباده مهما كثرت ذنوبهم، قال تعالى: {وَهُوَ الَّذِي يَقْبَلُ التَّوْبَةَ عَنْ عِبَادِهِ وَيَعْفُو عَنِ السَّيِّئَاتِ} [الشورى:25]"
        },
        {
            question: "كيف أتوب من الكذب وأنا مضطر إليه في عملي؟",
            answer: "ابحث عن عمل لا يحتاج إلى كذب، وتذكر أن الرزق بيد الله، وابدأ بالصدق ولو تدريجياً، واستعن بالله."
        },
        {
            question: "هل يمكن التوبة من عقوق الوالدين بعد موتهما؟",
            answer: "نعم، بالندم والاستغفار، والدعاء لهما، وصلة أرحامهما، وإخراج الصدقات عنهما، والوفاء بعهدهما."
        },
        {
            question: "كيف أتوب من حب الدنيا والانشغال بها عن الآخرة؟",
            answer: "بتذكر الموت والقبر والآخرة، ومجالسة الزاهدين في الدنيا، وقراءة سير الصالحين، والإكثار من ذكر الله."
        },
        {
            question: "أنا لا أشعر بثقل الذنب عندما أفعله، ما الحل؟",
            answer: "هذا من علامات قسوة القلب، والحل في الإكثار من الاستغفار، وقراءة القرآن، ومجالسة الصالحين، وتذكر الموت."
        },
        {
            question: "كيف أتوب من التسويف في التوبة؟",
            answer: "باستشعار خطر الموت المفاجئ، وتذكر أن كل لحظة تأخير هي فرصة ضائعة، والبدء فوراً في التوبة دون تأجيل."
        }
    ];
    
    // بيانات قصص النجاح
    const successStories = [
        {
            title: "توبة من سماع الأغاني",
            content: "بعد سنوات من إدمان الأغاني، قررت استبدالها بالقرآن. في البداية كان صعبًا، ولكن بعد شهر من المحاولة، شعرت براحة لم أعرفها من قبل. الآن أشعر أن قلبي أكثر نقاءً وهدوءًا."
        },
        {
            title: "عودة إلى الصلاة",
            content: "تركت الصلاة لمدة 5 سنوات، ولكن بعد سماع حديث 'العهد الذي بيننا وبينهم الصلاة'، عدت إلى الله. بدأت بالصلوات الخمس، والآن أحاول قضاء ما فاتني."
        },
        {
            title: "توبة من العلاقات المحرمة",
            content: "كانت لدي علاقة محرمة استمرت سنتين. بعد سماع آية {وَلا تَقْرَبُوا الزِّنَا}، قطعت العلاقة فورًا. تزوجت بعدها بطريقة شرعية، والآن أسأل الله أن يتقبل توبتي."
        },
        {
            title: "توبة من التدخين",
            content: "دخنت لمدة 10 سنوات، وحاولت الإقلاع عدة مرات وفشلت. بعد أن علمت بحكمه الشرعي، استعنت بالله وأقلعت عنه. بفضل الله لم أعد إليه منذ 3 سنوات."
        },
        {
            title: "توبة من الغيبة",
            content: "كنت لا أترك مجالاً إلا واغتبت فيه الناس. بعد أن علمت بحكم الغيبة وعقوبتها، تبت إلى الله وأصبحت أذكر الناس بخير بدلاً من ذكرهم بالسوء."
        }
    ];
    
    // تهيئة الصفحة
    initPage();
    
    function initPage() {
        // تعبئة الذنوب
        renderSins('all');
        
        // تعبئة الشبهات
        commonDoubts.forEach(doubt => {
            const doubtCard = document.createElement('div');
            doubtCard.className = 'doubt-card';
            doubtCard.innerHTML = `
                <div class="doubt-question">${doubt.question}</div>
                <div class="doubt-answer">${doubt.answer}</div>
            `;
            doubtsContainer.appendChild(doubtCard);
        });
        
        // تعبئة قصص النجاح
        successStories.forEach(story => {
            const storyCard = document.createElement('div');
            storyCard.className = 'story-card';
            storyCard.innerHTML = `
                <div class="story-title">${story.title}</div>
                <div class="story-content">${story.content}</div>
            `;
            storiesGrid.appendChild(storyCard);
        });
        
        // تحديث قسم التعهد
        updatePledgeSection();
        
        // إنشاء التقويم
        generateCalendar();
        
        // أحداث النقر على تصنيفات الذنوب
        categoryBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                categoryBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                renderSins(this.dataset.category);
            });
        });
        
        // أحداث التنقل بين الأشهر
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
        });
        
        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar();
        });
    }
    
    // عرض الذنوب حسب التصنيف
    function renderSins(category) {
        sinsGrid.innerHTML = '';
        const filteredSins = category === 'all' 
            ? commonSins 
            : commonSins.filter(sin => sin.category === category);
            
        filteredSins.forEach(sin => {
            const sinCard = document.createElement('div');
            sinCard.className = 'sin-card';
            sinCard.innerHTML = `
                <div class="sin-name">${sin.name}</div>
                <div class="sin-description">${sin.description}</div>
            `;
            sinCard.addEventListener('click', () => openSinModal(sin));
            sinsGrid.appendChild(sinCard);
        });
    }
    
    // فتح نافذة الذنب المفصل
    function openSinModal(sin) {
        currentSin = sin;
        modalTitle.textContent = sin.name;
        
        modalContent.innerHTML = `
            <div class="modal-section">
                <h3 class="modal-section-title"><i class="fas fa-question-circle"></i> لماذا يعتبر هذا الذنب؟</h3>
                <p class="modal-text">${sin.whySin}</p>
            </div>
            
            <div class="modal-section">
                <h3 class="modal-section-title"><i class="fas fa-exclamation-triangle"></i> حجم المعصية</h3>
                <p class="modal-text">${sin.severity}</p>
            </div>
            
            <div class="modal-section">
                <h3 class="modal-section-title"><i class="fas fa-list-ol"></i> كيفية التوبة من هذا الذنب</h3>
                <ol class="steps-list modal-text">
                    ${sin.repentanceSteps.map(step => `<li>${step}</li>`).join('')}
                </ol>
            </div>
            
            <div class="modal-section">
                <h3 class="modal-section-title"><i class="fas fa-award"></i> أجر من يتوب</h3>
                <p class="modal-text">${sin.reward}</p>
            </div>
            
            <div class="modal-section">
                <h3 class="modal-section-title"><i class="fas fa-book"></i> أدلة من القرآن والسنة</h3>
                <div class="evidences-list">
                    ${sin.evidences.map(evidence => `
                        <div class="evidence">
                            <p class="evidence-text">${evidence.text}</p>
                            <p class="evidence-ref">${evidence.ref}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        // تفعيل زر التعهد
        modalPledgeBtn.disabled = false;
        modalPledgeBtn.textContent = `أتعهد اليوم بعدم العودة لذنب ${sin.name}`;
        
        // عرض النافذة
        sinModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    // تحديث قسم التعهد
    function updatePledgeSection() {
        if (currentSin) {
            pledgeBtn.disabled = false;
            pledgeBtn.textContent = `أتعهد اليوم بعدم العودة لذنب ${currentSin.name}`;
        } else {
            pledgeBtn.disabled = true;
        }
        
        const today = new Date().toDateString();
        if (lastPledgeDate === today) {
            pledgeStats.innerHTML = `
                <div class="pledge-days">لقد تعهدت اليوم بعدم العودة لذنب ${currentSin ? currentSin.name : ''}</div>
                <div class="pledge-progress">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
                <div class="pledge-encouragement">الله معك وسيعينك على الوفاء بتعهدك</div>
            `;
        } else {
            pledgeStats.innerHTML = `
                <div class="pledge-days">أيام متتالية في التوبة: ${pledgeDays}</div>
                <div class="pledge-progress">
                    <div class="progress-bar" style="width: ${Math.min(pledgeDays * 10, 100)}%"></div>
                </div>
                <div class="pledge-encouragement">${getEncouragementMessage(pledgeDays)}</div>
            `;
        }
    }
    
    // إنشاء تقويم التوبة
    function generateCalendar() {
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDayOfMonth.getDate();
        const startingDay = firstDayOfMonth.getDay();
        
        const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
        calendarTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        
        // تحديد أيام التوبة في الشهر الحالي
        const currentMonthPledgeDays = pledgeHistory.filter(dateStr => {
            const date = new Date(dateStr);
            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        }).length;
        
        currentMonthDaysEl.textContent = currentMonthPledgeDays;
        
        // حساب عدد الأيام المتتالية
        let currentStreak = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let i = pledgeHistory.length - 1; i >= 0; i--) {
            const pledgeDate = new Date(pledgeHistory[i]);
            pledgeDate.setHours(0, 0, 0, 0);
            
            const expectedDate = new Date(today);
            expectedDate.setDate(today.getDate() - (pledgeHistory.length - 1 - i));
            
            if (pledgeDate.getTime() === expectedDate.getTime()) {
                currentStreak++;
            } else {
                break;
            }
        }
        
        currentStreakEl.textContent = currentStreak;
        totalDaysEl.textContent = pledgeHistory.length;
        
        // رؤوس الأيام
        const dayNames = ['أحد', 'اثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'];
        let calendarHTML = '';
        
        // إضافة رؤوس الأيام
        dayNames.forEach(day => {
            calendarHTML += `<div class="calendar-day day-header">${day}</div>`;
        });
        
        // إضافة أيام فارغة لبداية الشهر
        for (let i = 0; i < startingDay; i++) {
            calendarHTML += `<div class="calendar-day day-empty"></div>`;
        }
        
        // إضافة أيام الشهر
        const todayDate = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dateStr = date.toDateString();
            const isPledged = pledgeHistory.includes(dateStr);
            const isToday = date.getDate() === todayDate.getDate() && 
                            date.getMonth() === todayDate.getMonth() && 
                            date.getFullYear() === todayDate.getFullYear();
            
            let dayClass = 'calendar-day';
            if (isToday) {
                dayClass += ' day-current';
            } else if (isPledged) {
                dayClass += ' day-completed';
            } else if (date < todayDate && date.getDay() !== 5) { // تخطي الجمعة كمثال
                dayClass += ' day-missed';
            }
            
            calendarHTML += `<div class="${dayClass}">${day}</div>`;
        }
        
        calendarContainer.innerHTML = calendarHTML;
    }
    
    // رسائل تشجيعية
    function getEncouragementMessage(days) {
        if (days === 0) return "ابدأ رحلة التوبة اليوم وسيساعدك الله";
        if (days < 3) return "استمر! البداية تكون صعبة ولكنها تستحق";
        if (days < 7) return "أحسنت! أنت على الطريق الصحيح";
        if (days < 30) return `${days} يومًا دون عودة! الله معك`;
        return `${days} يومًا من التوبة! أنت مثال يُحتذى به`;
    }
    
    // التعهد بعدم العودة للذنب
    function makePledge() {
        if (!currentSin) return;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toDateString();
        
        if (lastPledgeDate !== todayStr) {
            // التحقق من التعهد المتتالي
            if (lastPledgeDate) {
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                if (lastPledgeDate === yesterdayStr) {
                    pledgeDays++;
                } else {
                    pledgeDays = 1;
                }
            } else {
                pledgeDays = 1;
            }
            
            lastPledgeDate = todayStr;
            pledgeHistory.push(todayStr);
            
            localStorage.setItem('pledgeDays', pledgeDays);
            localStorage.setItem('lastPledgeDate', lastPledgeDate);
            localStorage.setItem('pledgeHistory', JSON.stringify(pledgeHistory));
            
            updatePledgeSection();
            generateCalendar();
            showSuccessMessage(`بارك الله فيك! لقد تعهدت بعدم العودة لذنب ${currentSin.name} اليوم.`);
        } else {
            showInfoMessage('لقد تعهدت بالفعل اليوم! يمكنك تجديد التعهد غدًا بإذن الله.');
        }
    }
    
    // رسائل التنبيه
    function showSuccessMessage(message) {
        alert(message);
    }
    
    function showInfoMessage(message) {
        alert(message);
    }
    
    // أحداث النقر
    pledgeBtn.addEventListener('click', makePledge);
    modalPledgeBtn.addEventListener('click', function() {
        makePledge();
        closeModal.click();
    });
    
    // إغلاق النافذة
    closeModal.addEventListener('click', function() {
        sinModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    });
    
    // إغلاق عند النقر خارج النافذة
    sinModal.addEventListener('click', function(e) {
        if (e.target === sinModal) {
            closeModal.click();
        }
    });
    
    // زر العودة للأعلى
    window.addEventListener('scroll', function() {
        const scrollTop = document.getElementById('scrollTop');
        if (window.pageYOffset > 300) {
            scrollTop.classList.add('active');
        } else {
            scrollTop.classList.remove('active');
        }
    });
    
    document.getElementById('scrollTop').addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
    
    // تقديم قصة جديدة
    storyForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('story-title').value;
        const content = document.getElementById('story-content').value;

        if (!title || !content) {
            alert("الرجاء تعبئة جميع الحقول!");
            return;
        }

        try {
            await db.collection("stories").add({
                title: title,
                content: content,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: "pending",
                ip: await fetch('https://api.ipify.org?format=json').then(res => res.json()).then(data => data.ip)
            });

            alert("شكراً لمشاركة قصتك! سيتم مراجعتها قبل النشر.");
            this.reset();
        } catch (error) {
            console.error("Error adding story: ", error);
            alert("حدث خطأ أثناء الإرسال! يرجى المحاولة لاحقاً.");
        }
    });
});

// أضف هذه المتغيرات في قسم حالة التطبيق
let reminderInterval;
let pledgeEndTime;
let currentPledgeStreak = 0;
const pledgeReminders = {};

// أضف هذه الدوال الجديدة:

// بدء نظام التذكير
function startReminderSystem() {
    // إيقاف أي تذكيرات سابقة
    if (reminderInterval) clearInterval(reminderInterval);
    
    // إرسال تذكير فوري
    sendReminder();
    
    // إعداد التذكير كل ساعة
    reminderInterval = setInterval(sendReminder, 60 * 60 * 1000); // كل ساعة
    
    // تعيين وقت انتهاء التعهد (بعد 24 ساعة)
    pledgeEndTime = new Date();
    pledgeEndTime.setHours(pledgeEndTime.getHours() + 24);
    
    // تخزين معلومات التعهد
    pledgeReminders[currentSin.name] = {
        startTime: new Date(),
        endTime: pledgeEndTime,
        streak: currentPledgeStreak
    };
}

// إرسال تذكير
function sendReminder() {
    // طلب الإذن لإرسال الإشعارات (للمرة الأولى فقط)
    if (Notification.permission !== "granted") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                createNotification();
            }
        });
    } else {
        createNotification();
    }
    
    // أيضًا عرض تنبيه في الصفحة نفسها
    const reminderAlert = document.createElement('div');
    reminderAlert.className = 'reminder-alert';
    reminderAlert.innerHTML = `
        <div class="reminder-content">
            <i class="fas fa-bell"></i>
            <p>تذكير: أنت متعهد بعدم العودة لذنب <strong>${currentSin.name}</strong></p>
            <button class="close-reminder">&times;</button>
        </div>
    `;
    
    document.body.appendChild(reminderAlert);
    
    // إغلاق التنبيه عند النقر على الزر
    reminderAlert.querySelector('.close-reminder').addEventListener('click', () => {
        reminderAlert.remove();
    });
    
    // إزالة التنبيه تلقائيًا بعد 10 ثواني
    setTimeout(() => {
        if (reminderAlert.parentNode) {
            reminderAlert.remove();
        }
    }, 10000);
}

// إنشاء إشعار المتصفح
function createNotification() {
    if (!('Notification' in window)) return;
    
    const notification = new Notification('تذكير بالتعهد - توبتي', {
        body: `أنت متعهد بعدم العودة لذنب ${currentSin.name}. الله معك وسيعينك!`,
        icon: 'path/to/icon.png',
        lang: 'ar',
        vibrate: [200, 100, 200] // اهتزاز للجوالات
    });
    
    notification.onclick = () => {
        window.focus();
        notification.close();
    };
}

// عند انتهاء التعهد (بعد 24 ساعة)
function checkPledgeCompletion() {
    const now = new Date();
    if (pledgeEndTime && now >= pledgeEndTime) {
        showPledgeEvaluation();
        pledgeEndTime = null;
        if (reminderInterval) clearInterval(reminderInterval);
    }
}

// عرض استبيان التقييم
function showPledgeEvaluation() {
    const evaluationModal = document.createElement('div');
    evaluationModal.className = 'evaluation-modal';
    evaluationModal.innerHTML = `
        <div class="evaluation-content">
            <h3><i class="fas fa-check-circle"></i> تقييم التعهد</h3>
            <p>لقد انتهت مدة التعهد بعدم العودة لذنب <strong>${currentSin.name}</strong></p>
            
            <div class="evaluation-options">
                <button class="eval-option success">
                    <i class="fas fa-check"></i> وفيت بالتعهد ولم أعد للذنب
                </button>
                
                <button class="eval-option fail">
                    <i class="fas fa-times"></i> عدت للذنب وأريد التوبة مرة أخرى
                </button>
                
                <button class="eval-option renew">
                    <i class="fas fa-redo"></i> أريد تجديد التعهد لـ 24 ساعة أخرى
                </button>
            </div>
            
            <div class="streak-info">
                <p>عدد الأيام المتتالية في التوبة من هذا الذنب: <strong>${currentPledgeStreak}</strong></p>
            </div>
        </div>
    `;
    
    document.body.appendChild(evaluationModal);
    
    // أحداث الأزرار
    evaluationModal.querySelector('.success').addEventListener('click', () => {
        handlePledgeEvaluation(true);
        evaluationModal.remove();
    });
    
    evaluationModal.querySelector('.fail').addEventListener('click', () => {
        handlePledgeEvaluation(false);
        evaluationModal.remove();
    });
    
    evaluationModal.querySelector('.renew').addEventListener('click', () => {
        renewPledge();
        evaluationModal.remove();
    });
}

// معالجة تقييم التعهد
function handlePledgeEvaluation(success) {
    if (success) {
        currentPledgeStreak++;
        showCongratulations();
        
        // تحديث السجل المحلي
        const pledgeRecords = JSON.parse(localStorage.getItem('pledgeRecords') || '{}');
        pledgeRecords[currentSin.name] = pledgeRecords[currentSin.name] || { streaks: [] };
        pledgeRecords[currentSin.name].streaks.push({
            date: new Date().toISOString(),
            success: true,
            streak: currentPledgeStreak
        });
        localStorage.setItem('pledgeRecords', JSON.stringify(pledgeRecords));
    } else {
        currentPledgeStreak = 0;
        alert('لا تحزن! التوبة تجب ما قبلها. استغفر الله وعد للتوبة من جديد.');
    }
    
    // تحديث الواجهة
    updatePledgeSection();
    generateCalendar();
}

// تجديد التعهد
function renewPledge() {
    startReminderSystem();
    alert('تم تجديد التعهد لمدة 24 ساعة أخرى! سيتم إرسال التذكيرات كل ساعة.');
}

// عرض رسائل التهنئة
function showCongratulations() {
    let message = '';
    
    if (currentPledgeStreak === 3) {
        message = 'مبروك! لقد أكملت 3 أيام متتالية دون عودة للذنب. استمر على هذا الطريق!';
    } else if (currentPledgeStreak === 7) {
        message = 'أحسنت! لقد أكملت أسبوعًا كاملاً دون عودة للذنب. الله يثبتك ويزيدك من فضله!';
    } else if (currentPledgeStreak === 30) {
        message = 'تهانينا! لقد أكملت شهرًا كاملاً دون عودة للذنب. هذا إنجاز عظيم، بارك الله فيك!';
    }
    
    if (message) {
        const congratsModal = document.createElement('div');
        congratsModal.className = 'congrats-modal';
        congratsModal.innerHTML = `
            <div class="congrats-content">
                <div class="congrats-icon">
                    <i class="fas fa-medal"></i>
                </div>
                <h3>تهانينا!</h3>
                <p>${message}</p>
                <button class="close-congrats">حسنًا</button>
            </div>
        `;
        
        document.body.appendChild(congratsModal);
        
        congratsModal.querySelector('.close-congrats').addEventListener('click', () => {
            congratsModal.remove();
        });
    }
}

// تعديل دالة makePledge لبدء نظام التذكير
function makePledge() {
    if (!currentSin) return;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayStr = today.toDateString();
    
    if (lastPledgeDate !== todayStr) {
        // ... الكود السابق ...
        
        // بدء نظام التذكير
        startReminderSystem();
        
        // التحقق من انتهاء التعهد كل دقيقة
        setInterval(checkPledgeCompletion, 60 * 1000);
    }
    
    // ... باقي الكود السابق ...
}